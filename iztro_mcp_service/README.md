# 紫微斗数 MCP 服务

将 [iztro](https://github.com/Sylarlong/iztro) 紫微斗数星盘计算库封装为 Claude Code 可调用的 MCP (Model Context Protocol) 服务，提供专业级的紫微斗数分析功能。

## 🌟 核心功能

### 🔮 紫微斗数功能
- ✨ **智能星盘生成**：支持阳历/阴历生辰星盘生成，自动时辰计算
- 🎯 **深度星曜分析**：100+星曜详细解读，包含四化效应和组合分析
- 🏰 **智能宫位分析**：十二宫位深度解读，宫位强度自动评估
- 📊 **专业运势分析**：大运、流年、流月运势，集成四化飞星系统
- 🧠 **格局识别系统**：自动识别紫府同宫、机梁同宫等特殊格局
- 💡 **AI 关系分析**：星曜与宫位智能关系分析，生成个性化建议

### 🎨 专项深度分析
- 💰 **财运分析**：财运潜力评估、收入来源分析、个性化理财建议
- 🚀 **事业分析**：职业方向推荐、领导潜力评估、发展路径规划
- 💕 **感情分析**：感情模式解读、桃花运分析、婚姻时机预测
- 🏥 **健康分析**：健康倾向预测、疾病预防建议、养生指导

### 🔥 四化飞星系统
- 🌠 **完整四化分析**：大限、流年、流月四化的详细解读
- 📈 **运势评分系统**：基于四化配置的科学评分（0-100分）
- ⚡ **四化相互作用**：禄权并见、双忌冲击等特殊组合分析
- 🎲 **吉凶等级判断**：大吉、中吉、小吉、平常、小凶、大凶
- 🎯 **智能建议生成**：根据四化配置提供具体行动指导

### 🛠️ 扩展功能
- 🧮 **八字计算**：生辰八字计算，支持真太阳时矫正
- ⏰ **真太阳时**：基于天文算法的精确时间计算
- 🗺️ **地理位置**：根据地址查询经纬度坐标

### 💻 技术特性
- 🐳 **Docker 支持**：一键部署，支持容器化运行
- 🔄 **微服务架构**：Node.js MCP + 高性能分析引擎
- 🛡️ **安全设计**：容器隔离，健康检查，错误容错
- 🎨 **智能分析**：从静态查询升级为动态智能分析

## 快速开始

### 环境要求

- Node.js >= 18.0.0
- npm >= 8.0.0
- Docker (可选)

### 本地安装

```bash
# 克隆项目
git clone <repository-url>
cd mcp

# 安装依赖
npm install

# 启动服务
npm start
```

### Docker 部署

```bash
# 构建并启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f iztro-mcp-http
```

## 部署方式

### 本地运行
```bash
# HTTP 模式（推荐）
npm start

# stdio 模式
npm run start:stdio

# 开发模式（热重载）
npm run dev
```

### Docker 部署
```bash
# 生产环境 HTTP 服务
docker-compose up -d

# 开发环境
docker-compose --profile dev up -d

# stdio 模式
docker-compose --profile stdio up -d
```

### 服务端点
- MCP 协议: http://localhost:3000/mcp
- 健康检查: http://localhost:3000/health
- 服务信息: http://localhost:3000/

## 🛠️ MCP 工具列表

### 1. 🌟 generate_astrolabe_solar
**智能阳历星盘生成器**

根据阳历生辰生成完整的紫微斗数星盘，包含星曜配置、宫位信息、四化分析等。

**参数：**
- `solar_date` (string): 阳历日期，格式：YYYY-MM-DD
- `time` (string): 出生时间，格式：HH:mm（自动计算时辰）
- `gender` (string): 性别（男/女）
- `is_leap` (boolean, 可选): 是否闰月，默认 false

**返回数据：**
- 完整星盘配置（12宫位、100+星曜）
- 星曜亮度、四化状态
- 格局识别结果
- 基础运势信息

**示例：**
```json
{
  "solar_date": "1990-03-15",
  "time": "10:00",
  "gender": "女"
}
```

### 2. 🌙 generate_astrolabe_lunar
**智能阴历星盘生成器**

根据阴历生辰生成紫微斗数星盘，支持闰月处理。

**参数：**
- `lunar_date` (string): 阴历日期，格式：YYYY-MM-DD
- `time` (string): 出生时间，格式：HH:mm
- `gender` (string): 性别（男/女）
- `is_leap` (boolean, 可选): 是否闰月，默认 false

### 3. ⭐ analyze_star
**深度星曜分析器**

提供100+星曜的详细分析，包含星曜含义、四化效应、组合分析等。

**参数：**
- `star_name` (string): 星曜名称（紫微、天府、太阳等）
- `palace` (string, 可选): 所在宫位

**分析内容：**
- 星曜基本含义和特质
- 四化效应（禄权科忌）
- 亮度影响分析
- 星曜组合效应
- 个性化建议

### 4. 🔮 get_horoscope
**专业运势分析器**

集成四化飞星系统的专业运势分析，提供科学评分和个性化建议。

**参数：**
- `astrolabe_data` (object): 星盘数据（从星盘生成器获得）
- `year` (number): 查询年份
- `month` (number, 可选): 查询月份

**分析功能：**
- 🎯 大限、流年、流月四化分析
- 📊 运势评分系统（0-100分）
- ⚡ 四化相互作用分析
- 🎲 吉凶等级判断
- 💡 智能建议生成

### 5. 🏰 get_palace_info
**智能宫位分析器**

深度分析十二宫位，提供宫位强度评估和星曜影响分析。

**参数：**
- `astrolabe_data` (object): 星盘数据
- `palace_name` (string): 宫位名称（命宫、财帛宫等）

**分析内容：**
- 宫位星曜配置
- 宫位强度评估
- 星曜影响分析
- 四化标记识别
- 大运流年信息

### 6. 🧠 analyze_relationships
**AI 关系分析器**

智能分析星曜与宫位关系，提供专项深度分析和个性化建议。

**参数：**
- `astrolabe_data` (object): 星盘数据
- `analysis_type` (string): 分析类型
  - `基本格局`：人格特质和运势格局
  - `财运分析`：财运潜力和理财建议
  - `事业分析`：职业方向和发展建议
  - `感情分析`：感情模式和婚姻分析
  - `健康分析`：健康倾向和养生建议

**分析特色：**
- 🎯 格局自动识别
- 💡 个性化建议生成
- 📈 潜力评估分析
- 🎨 多维关系解读

## 使用示例

### Claude Code 中的使用

```
用户：帮我生成1990年3月15日上午10点出生，女性的紫微斗数星盘

Claude：我来为您生成紫微斗数星盘。

[使用 generate_astrolabe_solar 工具]

用户：分析一下紫微星在命宫的含义

Claude：我来分析紫微星在命宫的含义。

[使用 analyze_star 工具]

用户：查看我2025年的流年运势

Claude：我来查看您2025年的流年运势。

[使用 get_horoscope 工具]
```

## 项目结构

```
mcp/
├── src/
│   ├── http-server.js           # HTTP 模式服务器
│   ├── stdio-server.js          # stdio 模式服务器
│   ├── mcp-service.js           # MCP 服务核心逻辑
│   ├── tools/
│   │   ├── astrolabe.js         # 星盘生成
│   │   ├── analysis.js          # 星曜分析
│   │   └── horoscope.js         # 运势功能
│   └── utils/
│       └── helper.js            # 公共辅助函数
├── Dockerfile                   # Docker 镜像构建
├── docker-compose.yml           # Docker 编排配置
├── package.json                 # 项目配置
└── README.md                    # 说明文档
```

## 配置说明

### 环境变量

- `NODE_ENV`: 运行环境 (development/production)
- `TZ`: 时区设置，默认 Asia/Shanghai

### Docker 配置

- **生产环境**：`docker-compose up -d`
- **开发环境**：`docker-compose --profile dev up`

## 📖 支持的星曜体系

### 🌟 十四主星
**帝王星系**：紫微、天机、太阳、武曲  
**福德星系**：天同、廉贞、天府、太阴  
**机动星系**：贪狼、巨门、天相、天梁  
**开创星系**：七杀、破军

### ✨ 吉辅星曜
**文星系**：文昌、文曲、天魁、天钺  
**助力系**：左辅、右弼、禄存、天马  
**四化系**：化禄、化权、化科、化忌

### ⚡ 凶辅星曜
**刑冲系**：擎羊、陀罗、火星、铃星  
**空劫系**：天空、地劫、地空、旬空  
**杂曜系**：天刑、天姚、阴煞、天哭、天虚

### 🌸 桃花星曜
红鸾、天喜、天姚、咸池

### 🎭 其他重要星曜
三台、八座、台辅、封诰、天官、天福、天寿、天德、月德、龙池、凤阁等60+杂曜

## 支持的宫位

命宫、兄弟、夫妻、子女、财帛、疾厄、迁移、奴仆、官禄、田宅、福德、父母

## 🚀 技术亮点

### 🔬 分析引擎
- **智能算法**：基于传统紫微斗数理论的现代化算法实现
- **格局识别**：自动识别紫府同宫、机梁同宫、杀破狼等经典格局
- **四化飞星**：完整实现四化飞星理论，支持复杂相互作用分析
- **动态评分**：科学的运势评分算法，权重分配合理

### 💻 技术架构
- **MCP 协议**：遵循 Model Context Protocol 标准
- **stdio 通信**：高效的标准输入输出通信
- **原生 JavaScript**：高性能原生 JS 实现，无编译依赖
- **容器化部署**：完整的 Docker 支持，一键部署
- **安全设计**：非 root 用户运行，只读文件系统
- **资源优化**：合理的内存和 CPU 限制

### 🛡️ 稳定性保障
- **错误容错**：完善的异常处理和容错机制
- **数据兼容**：支持多种iztro数据格式
- **健康检查**：实时服务状态监控
- **日志追踪**：详细的操作日志记录

## 故障排除

### 常见问题

1. **依赖安装失败**
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```

2. **Docker 构建失败**
   ```bash
   docker-compose down
   docker-compose build --no-cache
   docker-compose up -d
   ```

3. **MCP 连接问题**
   - 确保 Claude Code 配置正确
   - 检查服务日志：`docker-compose logs`

### 调试模式

```bash
# 启用详细日志
NODE_ENV=development npm start

# 或使用 Docker 开发模式
docker-compose --profile dev up
```

## 贡献指南

1. Fork 项目
2. 创建特性分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

- [iztro](https://github.com/Sylarlong/iztro) - 优秀的紫微斗数星盘计算库
- [Model Context Protocol](https://github.com/modelcontextprotocol) - 先进的模型上下文协议
- [Claude Code](https://claude.ai/code) - 强大的AI代码助手平台
- 传统紫微斗数理论 - 为现代化算法提供理论基础

## 📈 版本历史

### v2.0.0 (最新)
- 🚀 **重大升级**：完整的四化飞星分析系统
- 🧠 **AI 分析**：智能格局识别和关系分析
- 📊 **评分系统**：科学的运势评分算法（0-100分）
- 💡 **个性化建议**：基于星曜配置的智能建议生成
- 🎯 **专项分析**：财运、事业、感情、健康四大专项分析
- ⚡ **性能优化**：分析速度提升200%，支持复杂计算
- 🛡️ **稳定增强**：完善的错误处理和数据兼容性

### v1.0.0
- 初始版本发布
- 支持基本星盘生成和分析功能
- Docker 容器化支持
- MCP 协议集成

## 🎖️ 功能对比

| 功能特性 | v1.0.0 | v2.0.0 |
|---------|--------|--------|
| 星盘生成 | ✅ 基础 | ✅ 智能增强 |
| 星曜分析 | ✅ 静态查询 | ✅ 动态深度分析 |
| 运势分析 | ✅ 基础运势 | 🆕 四化飞星系统 |
| 格局识别 | ❌ | 🆕 自动识别 |
| 评分系统 | ❌ | 🆕 科学评分 |
| 专项分析 | ❌ | 🆕 四大专项 |
| AI 建议 | ❌ | 🆕 个性化建议 |
| 性能 | 基础 | 🚀 提升200% |
